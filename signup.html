<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Starlight Expense</title>

    <link rel="stylesheet" href="style.css">
    <link rel="shortcut icon" href="3.png" type="image/x-icon">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<h2>Welcome back, <span id="user-display-name">User</span>!</h2>
<p style="font-size: 0.8rem; color: gray;">
    Tracking since: <span id="user-joined-date">Today</span>
</p>

<div class="container">
    <header>
        <h1>Spend-Wise</h1>
        <p>Track your spending, master your budget.</p>
    </header>

    <main class="dashboard">
        <!-- ADD EXPENSE -->
        <section class="input-card">
            <h3>Add New Expense</h3>
            <form id="expense-form">
                <input type="text" id="description" placeholder="Your expense here!" required>
                <input type="number" id="amount" placeholder="Amount (Naira)" required>
                <select id="category">
                    <option value="Food">Food</option>
                    <option value="Rent">Rent</option>
                    <option value="Transport">Transport</option>
                    <option value="Entertainment">Entertainment</option>
                </select>
                <button type="submit">Add Expense</button>
            </form>
        </section>

        <!-- CHART -->
        <section class="chart-card">
            <canvas id="expenseChart"></canvas>
        </section>
    </main>
</div>

<!-- TRANSACTIONS -->
<section class="history-card">
    <h3>Recent Transactions</h3>
    <ul id="transaction-list"></ul>

    <button id="clear-btn" style="
        margin-top: 10px;
        padding: 10px;
        background: red;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
    ">
        Clear All Transactions
    </button>
</section>

<!-- ================= SCRIPT ================= -->
<script>
/* ðŸ” SECURITY GUARD */
const sessionUser =
    sessionStorage.getItem('activeUser') ||
    localStorage.getItem('activeUser');

if (!sessionUser) {
    window.location.href = "login.html";
} else {
    document.getElementById("user-display-name").innerText = sessionUser;
}

/* ðŸ“¦ STORAGE */
let expenses = JSON.parse(localStorage.getItem("expenses")) || [];

/* ðŸ“‹ ELEMENTS */
const form = document.getElementById("expense-form");
const list = document.getElementById("transaction-list");
const clearBtn = document.getElementById("clear-btn");
const ctx = document.getElementById("expenseChart").getContext("2d");

let expenseChartInstance;

/* âž• ADD EXPENSE */
form.addEventListener("submit", (e) => {
    e.preventDefault();

    const description = document.getElementById("description").value;
    const amount = Number(document.getElementById("amount").value);
    const category = document.getElementById("category").value;

    expenses.push({ description, amount, category });
    localStorage.setItem("expenses", JSON.stringify(expenses));

    form.reset();
    renderAll();
});

/* ðŸ§¾ RENDER TRANSACTIONS */
function renderTransactions() {
    list.innerHTML = "";
    expenses.forEach(exp => {
        const li = document.createElement("li");
        li.textContent = `${exp.description} - â‚¦${exp.amount} (${exp.category})`;
        list.appendChild(li);
    });
}

/* ðŸ“Š RENDER CHART */
function renderChart() {
    const categories = {};
    expenses.forEach(exp => {
        categories[exp.category] = (categories[exp.category] || 0) + exp.amount;
    });

    if (expenseChartInstance) {
        expenseChartInstance.destroy();
    }

    expenseChartInstance = new Chart(ctx, {
        type: "pie",
        data: {
            labels: Object.keys(categories),
            datasets: [{
                data: Object.values(categories)
            }]
        }
    });
}

/* ðŸ” RENDER EVERYTHING */
function renderAll() {
    renderTransactions();
    renderChart();
}

/* âŒ CLEAR ALL */
clearBtn.addEventListener("click", () => {
    if (!confirm("Are you sure you want to clear all transactions?")) return;

    localStorage.removeItem("expenses");
    expenses = [];

    if (expenseChartInstance) {
        expenseChartInstance.destroy();
    }

    list.innerHTML = "";
});

/* ðŸš€ INIT */
renderAll();
</script>

</body>
</html>